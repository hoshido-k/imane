# imane（イマネ） - 位置情報ベース自動通知アプリ

> **注**: このプロジェクトは poplink のコードベースをベースに、位置情報自動通知機能に特化して開発されています。

## 📱 プロジェクト概要

**imane（イマネ）** は、「今ね、ここにいるよ」を自動で伝える位置情報ベースの自動通知アプリです。
事前に目的地を設定しておくだけで、到着・滞在・退出のタイミングで大切な人に自動で通知を送信します。

### コンセプト
- **さりげない気配り**：携帯を開かずに自動で位置情報を共有
- **プライバシー重視**：必要な時だけ、選んだ相手にだけ通知
- **シンプルな体験**：複雑なチャット機能なし、通知に特化
- **自然な言葉**：「今ね、」で始まる親しみやすいメッセージ

> 💡 **imane** の名前は、「今ね」という日本語の自然な会話表現から。パートナーや家族に「今ね、ここに着いたよ」と気軽に伝えるイメージです。

---

## ✨ 主な機能

### MVP（Phase 1）機能

#### 1. 目的地設定機能
- **入力方式**：手動入力 / 地図から選択
- **到着判定範囲**：50m圏内
- **有効期限**：時間指定（開始時刻〜終了時刻）
- **定期設定**：平日は職場、毎週金曜は特定の場所など
- **複数設定**：同時に複数の目的地を設定可能（例：昼は職場、夜は飲み屋）
- **お気に入り登録**：よく行く場所を保存して簡単再利用

#### 2. 自動通知機能
imaneは以下の3つのタイミングで自動通知を送信します：

##### 🟢 到着通知
```
今ね、{ユーザー名}さんが{目的地名}へ到着したよ
到着時刻: 18:30
ここにいるよ → [地図リンク]
```

##### 🟡 滞在通知（1時間後）
```
今ね、{ユーザー名}さんは{目的地名}に1時間30分滞在しているよ
ここにいるよ → [地図リンク]
```

##### 🔴 退出通知
```
今ね、{ユーザー名}さんが{目的地名}から出発したよ
出発時刻: 21:00
```

#### 3. 通知先管理
- フレンド機能を使って通知先を選択
- 予定ごとに通知先を個別設定可能

#### 4. 位置情報トラッキング
- **更新頻度**：10分間隔（バッテリー節約重視）
- **バックグラウンド動作**：アプリを閉じていても自動追跡
- **ジオフェンシング**：50m圏内到着を自動判定
- **プライバシー**：位置情報は24時間で自動削除

#### 5. 通知チャネル
- **Firebase Cloud Messaging（FCM）**：プッシュ通知
- **通知履歴**：過去24時間分を確認可能

---

### Phase 2（将来追加機能）
- ⏸️ 予定のキャンセル機能
- 🔕 通知の一時停止機能
- 👥 通知先グループ設定（「家族」「パートナー」など）
- 📲 LINE Messaging API統合
- 🤖 Android対応

---

## 🛠️ 技術スタック

### バックエンド（Python/FastAPI）
```
流用元: poplink
✅ 認証システム (Firebase Auth + JWT)
✅ フレンド管理
✅ プッシュ通知基盤（FCM）
✅ ユーザー管理
❌ チャット機能（削除済み）

imane新規追加:
🆕 位置情報スケジュール管理API
🆕 位置情報トラッキングAPI
🆕 ジオフェンシングロジック
🆕 自動通知トリガーシステム
🆕 お気に入り場所管理API
```

### フロントエンド（Flutter/iOS）
```
流用元: poplink
✅ 地図表示・選択UI（Google Maps API）
✅ 認証画面
✅ フレンド管理画面

imane新規開発:
🆕 予定作成・編集画面
🆕 目的地設定フロー
🆕 お気に入り場所管理画面
🆕 バックグラウンド位置情報取得
🆕 通知履歴画面
🆕 現在の状態ダッシュボード
```

### インフラ
- **Firebase Authentication**：ユーザー認証
- **Firestore**：データベース
- **Firebase Cloud Messaging**：プッシュ通知
- **Google Maps Platform**：地図表示・ジオコーディング
- **iOS Background Location**：バックグラウンド位置情報取得

---

## 📊 データモデル（Firestore）

### LocationSchedule（位置情報スケジュール）
```json
{
  "id": "schedule_123",
  "user_id": "user_abc",
  "destination_name": "新宿の居酒屋",
  "destination_address": "東京都新宿区...",
  "destination_coords": {
    "lat": 35.689487,
    "lng": 139.691706
  },
  "geofence_radius": 50,
  "notify_to_user_ids": ["user_xyz"],
  "start_time": "2025-11-04T18:00:00Z",
  "end_time": "2025-11-04T23:59:59Z",
  "recurrence": "weekdays",  // null, "daily", "weekdays", "weekends"
  "notify_on_arrival": true,
  "notify_after_minutes": 60,
  "notify_on_departure": true,
  "status": "active",  // "active", "arrived", "completed", "expired"
  "arrived_at": "2025-11-04T18:30:00Z",
  "departed_at": null,
  "favorite": false,
  "created_at": "2025-11-04T12:00:00Z",
  "updated_at": "2025-11-04T12:00:00Z"
}
```

### FavoriteLocation（お気に入り場所）
```json
{
  "id": "fav_456",
  "user_id": "user_abc",
  "name": "会社",
  "address": "東京都港区...",
  "coords": {
    "lat": 35.658034,
    "lng": 139.701636
  },
  "created_at": "2025-11-04T12:00:00Z"
}
```

### LocationHistory（位置情報履歴）
```json
{
  "id": "history_789",
  "user_id": "user_abc",
  "schedule_id": "schedule_123",
  "coords": {
    "lat": 35.689487,
    "lng": 139.691706
  },
  "recorded_at": "2025-11-04T18:35:00Z",
  "auto_delete_at": "2025-11-05T18:35:00Z"  // 24時間後
}
```

### NotificationHistory（通知履歴）
```json
{
  "id": "notif_012",
  "from_user_id": "user_abc",
  "to_user_id": "user_xyz",
  "schedule_id": "schedule_123",
  "type": "arrival",  // "arrival", "stay", "departure"
  "message": "今ね、太郎さんが新宿の居酒屋へ到着したよ",
  "map_link": "https://maps.google.com/?q=35.689487,139.691706",
  "sent_at": "2025-11-04T18:30:00Z",
  "auto_delete_at": "2025-11-05T18:30:00Z"
}
```

---

## 🏗️ システムアーキテクチャ

```
Flutter App (iOS)
 ├─ 予定設定画面
 ├─ 地図選択
 ├─ フレンド選択
 ├─ 通知履歴
 │
 ├─ Background Location Service (10分間隔)
 │   └─ 位置情報をバックエンドに送信
 │
 ▼
FastAPI Backend
 ├─ REST API
 │   ├─ /api/v1/schedules (予定管理)
 │   ├─ /api/v1/favorites (お気に入り)
 │   ├─ /api/v1/location/update (位置情報更新)
 │   └─ /api/v1/notifications/history (通知履歴)
 │
 ├─ Geofencing Service (ジオフェンス判定)
 │   └─ 50m圏内到着・退出を検知
 │
 ├─ Auto Notification Trigger
 │   ├─ 到着通知
 │   ├─ 滞在通知（1時間後）
 │   └─ 退出通知
 │
 ▼
Firebase Services
 ├─ Firestore（データ保存）
 ├─ Cloud Functions（定期削除・通知トリガー）
 ├─ Firebase Auth（認証）
 └─ Firebase Cloud Messaging（プッシュ通知）
```

---

## 📐 API設計

### 認証・ユーザー（流用）
```
POST   /api/v1/auth/signup          # 新規登録
POST   /api/v1/auth/login           # ログイン
GET    /api/v1/users/me             # プロフィール取得
PUT    /api/v1/users/me             # プロフィール更新
```

### フレンド管理（流用）
```
POST   /api/v1/friends/request      # フレンドリクエスト送信
POST   /api/v1/friends/accept       # フレンドリクエスト承認
GET    /api/v1/friends              # フレンド一覧
DELETE /api/v1/friends/{friend_id}  # フレンド削除
```

### 予定管理（新規）
```
POST   /api/v1/schedules            # 予定作成
GET    /api/v1/schedules            # 予定一覧
GET    /api/v1/schedules/{id}       # 予定詳細
PUT    /api/v1/schedules/{id}       # 予定更新
DELETE /api/v1/schedules/{id}       # 予定削除（Phase 2）
```

### お気に入り場所（新規）
```
POST   /api/v1/favorites            # お気に入り追加
GET    /api/v1/favorites            # お気に入り一覧
DELETE /api/v1/favorites/{id}       # お気に入り削除
```

### 位置情報トラッキング（新規）
```
POST   /api/v1/location/update      # 位置情報送信
GET    /api/v1/location/status      # 現在のステータス取得
```

### 通知（拡張）
```
POST   /api/v1/notifications/register  # FCMトークン登録
GET    /api/v1/notifications/history   # 通知履歴（24時間）
```

---

## 🚀 ユースケースシナリオ

### 飲み会シナリオ
```
1. [朝10:00]  太郎が「今夜、新宿の居酒屋で飲み会」を設定
              - 目的地：新宿の居酒屋（地図から選択）
              - 開始時刻：18:00
              - 終了時刻：23:59
              - 通知先：妻（花子）

2. [夜18:30]  太郎が居酒屋に到着（50m圏内）
              → 花子に自動通知
              「今ね、太郎さんが新宿の居酒屋へ到着したよ」

3. [夜19:30]  1時間滞在
              → 花子に自動通知
              「今ね、太郎さんは新宿の居酒屋に1時間滞在しているよ」

4. [夜21:00]  太郎が退出（50m圏外）
              → 花子に自動通知
              「今ね、太郎さんが新宿の居酒屋から出発したよ」

5. [翌日10:00] 位置情報・通知履歴が自動削除（24時間経過）
```

---

## 💰 コスト見積もり（個人開発規模）

| サービス | 使用量 | 月額コスト |
|-----------|----------|--------------|
| Firestore | 読取: 50,000 / 書込: 10,000 | **$0**（無料枠内） |
| Cloud Functions | 10,000回/月 | **$0** |
| Firebase Auth | 1,000ユーザー | **$0** |
| FCM | 無制限 | **$0** |
| Maps API | 5,000リクエスト | **$0** |

> ✅ **個人開発なら実質無料運用可能**

---

## 📈 実装フェーズ

### Phase 1: MVP（2〜3ヶ月）
**目標：基本的な自動通知機能を実装**

1. **Week 1-2: セットアップ**
   - Firebaseプロジェクト作成
   - バックエンドAPI実装（予定管理）
   - お気に入り場所API

2. **Week 3-4: 位置情報トラッキング**
   - バックグラウンド位置情報取得（iOS）
   - ジオフェンシングロジック
   - 位置情報更新API

3. **Week 5-6: 自動通知システム**
   - 到着通知トリガー
   - 滞在通知トリガー（1時間）
   - 退出通知トリガー
   - FCM統合

4. **Week 7-8: フロントエンド開発**
   - 予定作成画面
   - 地図選択UI（poplinkから流用）
   - 通知履歴画面
   - お気に入り管理画面

5. **Week 9-10: テスト・デバッグ**
   - 実機テスト（iOS）
   - バックグラウンド動作確認
   - 通知タイミング調整
   - TestFlight配信

### Phase 2: 機能拡張（1〜2ヶ月）
- 予定のキャンセル・一時停止機能
- 通知先グループ設定
- LINE Messaging API統合
- 統計・ダッシュボード機能

### Phase 3: プラットフォーム拡大（2〜3ヶ月）
- Android対応
- PWA対応（オプション）
- Apple Watch対応（オプション）

---

## 🔒 プライバシー・セキュリティ

### データ保持ポリシー
- **位置情報履歴**：24時間で自動削除
- **通知履歴**：24時間で自動削除
- **予定情報**：終了時刻から24時間後に自動削除
- **お気に入り場所**：ユーザーが削除するまで保持

### セキュリティ対策
- Firebase Authによる認証
- JWTトークンによるAPI保護
- 位置情報の暗号化保存
- フレンドのみに通知先を制限
- HTTPS通信の強制

### iOS位置情報権限
- **Always Allow（常に許可）**：バックグラウンド位置情報取得に必要
- 明示的な許可リクエストとプライバシー説明
- 位置情報の利用目的を明確に表示

---

## 🧩 ブランド説明

> **imane（イマネ）** は、
> 「今ね、ここにいるよ」という自然な会話表現から生まれた位置情報アプリです。
> 大切な人に気配りを伝える、さりげないコミュニケーションツールとして、
> プライバシーを守りながら、必要な時だけ自動で位置を共有します。

---

## 📝 開発メモ

### poplinkからの主な変更点
- ✂️ チャット機能を完全削除
- 🆕 位置情報スケジュール管理を追加
- 🆕 ジオフェンシング機能を追加
- 🆕 自動通知トリガーシステムを追加
- 🆕 お気に入り場所管理を追加
- 📝 「今ね、」フレーズを使った通知メッセージ

### 技術的な課題
1. **バッテリー消費**：10分間隔での位置情報取得
   - 対策：ジオフェンスAPIの活用、スリープモード対応

2. **通知タイミングの精度**：50m圏内判定
   - 対策：GPS精度の考慮、複数回判定での誤検知防止

3. **iOS Background Mode**：位置情報の継続取得
   - 対策：適切な権限設定、Apple審査対応

---

**プロジェクト開始日:** 2025-11-04
**最終更新日:** 2025-11-04
**Version:** 1.0.0-MVP
