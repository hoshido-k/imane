# imane 実機テストガイド

**テスト完了後、このファイルは削除してください**

---

## 📋 テスト前のチェックリスト

- [×] iPhone実機を用意（iOS 14以上推奨）
- [×] Apple Developer アカウント（無料版でOK）
- [×] Xcodeインストール済み
- [×] バックエンドAPIが起動中（`http://localhost:8000`）

---

## 🔧 1. 事前準備

### 1.1 パッケージのインストール

```bash
cd mobile

# 依存パッケージをインストール
fvm flutter pub get

# iOS Podのインストール
cd ios
pod install
cd ..
```

### 1.2 Xcode設定

1. Xcodeで `mobile/ios/Runner.xcworkspace` を開く
   ```bash
   open ios/Runner.xcworkspace
   ```

2. **Signing & Capabilities** タブを開く：
   - 左のナビゲーターで「Runner」プロジェクトを選択
   - 「Signing & Capabilities」タブをクリック
   - **Team**: あなたのApple IDを選択
   - **Bundle Identifier**: `com.yourname.imane` など一意のIDに変更

3. **Background Modes** を確認：
   - 「+ Capability」ボタンをクリック
   - 「Background Modes」を検索して追加（既に追加済みの場合はスキップ）
   - 以下にチェックが入っているか確認：
     - ✓ Location updates
     - ✓ Background fetch
     - ✓ Remote notifications

### 1.3 実機をMacに接続

1. iPhoneをUSBケーブルでMacに接続
2. iPhone側で「このコンピュータを信頼しますか？」→「信頼」
3. 接続を確認：
   ```bash
   fvm flutter devices
   ```

   出力例：
   ```
   iPhone 15 (mobile) • 00008030-XXXXXXXXXXXX • ios • iOS 17.0
   ```

---

## 🚀 2. アプリのビルド＆実行

### 2.1 Releaseモードで実行（バッテリー測定用）

```bash
# デバイスIDを確認
fvm flutter devices

# Releaseモードでビルド＆実行
fvm flutter run --release -d <デバイスID>

# または簡単に（接続デバイスが1つの場合）
fvm flutter run --release
```

### 2.2 デバッグモードで実行（ログ確認用）

```bash
fvm flutter run -d <デバイスID>
```

---

## ✅ 3. テストシナリオ

### Test 1: 位置情報権限リクエスト

**目的**: 権限リクエストフローが正常に動作するか確認

1. [ ] アプリを初回起動
2. [ ] 「位置情報の許可が必要です」画面が表示される
3. [ ] 「位置情報の許可を設定」ボタンをタップ
4. [ ] iOSの権限ダイアログが表示される
5. [ ] 「Appの使用中は許可」を選択
6. [ ] 「常に許可」への変更ダイアログが表示される
7. [ ] 「設定を開く」をタップ
8. [ ] 設定アプリが開く
9. [ ] 「位置情報」→「常に」を選択
10. [ ] アプリに戻り、「続ける」ボタンが表示される

**期待結果**: ✅ 権限が「常に許可」になっている

---

### Test 2: デバッグ画面の動作確認

**目的**: LocationServiceが正常に動作するか確認

1. [ ] アプリのメイン画面で、右上の「デバッグ」アイコン（虫アイコン）をタップ
2. [ ] Location Debug 画面が開く
3. [ ] **権限ステータス**: `always` と表示されている
4. [ ] **トラッキング状態**: `停止中` と表示されている
5. [ ] 「トラッキング開始」ボタンをタップ
6. [ ] **トラッキング状態**: `実行中` に変わる
7. [ ] **現在位置**に緯度・経度が表示される
8. [ ] ログに「Location tracking started successfully」が表示される

**期待結果**: ✅ トラッキングが開始され、現在位置が表示される

---

### Test 3: バックグラウンドでの位置情報取得

**目的**: アプリをバックグラウンドに移しても位置情報を取得できるか

1. [ ] デバッグ画面でトラッキングを開始
2. [ ] ホームボタン（またはスワイプアップ）でアプリをバックグラウンドに移動
3. [ ] 10分待機（⏰タイマーをセット）
4. [ ] アプリに戻る
5. [ ] ログを確認：「Location update received」が表示されている
6. [ ] **最終更新時刻**が現在時刻に近い

**Xcodeコンソールでログを確認する方法**:
```bash
# 別のターミナルウィンドウで
fvm flutter logs
```

**期待結果**:
- ✅ 10分後に位置情報が取得されている
- ✅ ログに「Location sent to API successfully」が表示される

---

### Test 4: 実際の移動テスト

**目的**: 実際に移動したときに位置情報が更新されるか

1. [ ] デバッグ画面でトラッキングを開始
2. [ ] 現在の緯度・経度をメモ
3. [ ] アプリをバックグラウンドに移動
4. [ ] 外に出て50m以上歩く（Googleマップなどで距離確認）
5. [ ] 10分待機
6. [ ] アプリに戻る
7. [ ] デバッグ画面の**現在位置**が更新されている
8. [ ] 移動距離が表示されている（50m以上）

**期待結果**:
- ✅ 位置情報が更新されている
- ✅ 移動距離が正しく計算されている

---

### Test 5: ネットワーク切断時のキャッシュ機能

**目的**: オフライン時にキャッシュに保存され、オンライン復帰時にリトライされるか

1. [ ] デバッグ画面でトラッキングを開始
2. [ ] iPhoneのコントロールセンターから**機内モード**をON
3. [ ] 10分待機
4. [ ] デバッグ画面で**キャッシュ数**が増えている（1以上）
5. [ ] ログに「Location cached for later retry」が表示される
6. [ ] **機内モード**をOFF
7. [ ] 数秒待つ
8. [ ] ログに「Connection restored. Retrying cached locations...」が表示される
9. [ ] ログに「Retry complete. Success: 1」が表示される
10. [ ] **キャッシュ数**が0に戻る

**期待結果**:
- ✅ オフライン時にキャッシュに保存される
- ✅ オンライン復帰時に自動的にリトライされる
- ✅ リトライ成功後、キャッシュが削除される

---

### Test 6: バッテリー消費測定

**目的**: バックグラウンドトラッキングのバッテリー消費が許容範囲内か

#### 準備
1. [ ] iPhoneを100%まで充電
2. [ ] 他のアプリを全て終了
3. [ ] 画面の明るさを50%に設定
4. [ ] 自動ロックを「1分」に設定

#### 測定（6時間）
1. [ ] デバッグ画面でトラッキングを開始
2. [ ] アプリをバックグラウンドに移動
3. [ ] iPhoneを普通に使用（通話、SNSなど）
4. [ ] **6時間後**にバッテリー残量を確認
5. [ ] 設定 → バッテリー → imane の消費量を確認

#### 記録
- 開始時のバッテリー: ____%
- 6時間後のバッテリー: ____%
- imaneの消費量: ____%
- 全体の消費量: ____%

**目標**: 6時間で2.5%以内（1日10%以内）

**期待結果**: ✅ バッテリー消費が目標範囲内

---

### Test 7: アプリ再起動後のトラッキング復元

**目的**: アプリを終了しても、トラッキング状態が復元されるか

1. [ ] デバッグ画面でトラッキングを開始
2. [ ] アプリを完全に終了（タスクキルする）
   - ホームボタン2回押し（またはスワイップアップして止める）
   - imaneを上にスワイプして終了
3. [ ] iPhoneを再起動
4. [ ] アプリを再度起動
5. [ ] デバッグ画面を開く
6. [ ] **トラッキング状態**: `実行中` と表示される
7. [ ] 位置情報が取得され続けている

**期待結果**: ✅ トラッキング状態が復元される

---

## 🐛 4. トラブルシューティング

### エラー: "background_location を使用できません"

**原因**: Info.plist の設定が不足

**解決策**:
```bash
# Info.plistを確認
cat ios/Runner/Info.plist | grep -A 2 "NSLocationAlways"
```

以下が含まれているか確認：
- `NSLocationWhenInUseUsageDescription`
- `NSLocationAlwaysAndWhenInUseUsageDescription`
- `UIBackgroundModes`

### エラー: "位置情報を取得できません"

**原因**: 位置情報サービスがOFF

**解決策**:
1. 設定 → プライバシーとセキュリティ → 位置情報サービス → ON
2. imane → 「常に」を選択

### エラー: "API送信に失敗しました"

**原因**: バックエンドAPIが起動していない、またはURLが間違っている

**解決策**:
```bash
# バックエンドが起動しているか確認
curl http://localhost:8000/health

# または、mobile/lib/services/api_service.dart のbaseUrlを確認
# 実機の場合、PCのIPアドレスを使う必要があります：
# static const String baseUrl = 'http://192.168.x.x:8000/api/v1';
```

PCのIPアドレスを確認：
```bash
# macOS
ipconfig getifaddr en0
```

### バックグラウンドで位置情報が取得されない

**原因**: background_location の設定が不正

**解決策**:
1. Xcodeで「Clean Build Folder」（Shift + Command + K）
2. アプリを削除してから再インストール
3. 位置情報の権限を「常に」に設定し直す

---

## 📊 5. テスト結果レポート

以下のフォーマットでテスト結果を記録してください：

```
## テスト実施日: 2025-XX-XX

### 環境
- デバイス: iPhone XX
- iOS バージョン: XX.X
- ビルドモード: Release / Debug

### Test 1: 位置情報権限リクエスト
- 結果: ✅ 成功 / ❌ 失敗
- メモ:

### Test 2: デバッグ画面の動作確認
- 結果: ✅ 成功 / ❌ 失敗
- メモ:

### Test 3: バックグラウンドでの位置情報取得
- 結果: ✅ 成功 / ❌ 失敗
- メモ:

### Test 4: 実際の移動テスト
- 結果: ✅ 成功 / ❌ 失敗
- 移動距離: ___m
- メモ:

### Test 5: オフライン時のキャッシュ機能
- 結果: ✅ 成功 / ❌ 失敗
- メモ:

### Test 6: バッテリー消費測定
- 結果: ✅ 目標達成 / ❌ 目標未達成
- 6時間での消費: ____%
- メモ:

### Test 7: トラッキング状態の復元
- 結果: ✅ 成功 / ❌ 失敗
- メモ:

### 総合評価
- [ ] すべてのテストが成功
- [ ] 一部失敗（詳細を下記に記載）

### 追加メモ・気づいた点

```

---

## 🎯 6. テスト完了の基準

以下がすべて ✅ になればテスト完了です：

- [ ] 位置情報権限が「常に許可」に設定できる
- [ ] バックグラウンドで10分間隔で位置情報を取得できる
- [ ] 実際に移動したときに位置情報が更新される
- [ ] オフライン時にキャッシュに保存され、オンライン復帰時にリトライされる
- [ ] バッテリー消費が6時間で2.5%以内（1日10%以内）
- [ ] アプリ再起動後もトラッキング状態が復元される
- [ ] クリティカルなバグやクラッシュがない

---

**テスト完了後、このファイル（DEVICE_TESTING_GUIDE.md）を削除してください**
